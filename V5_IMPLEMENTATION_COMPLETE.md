# ğŸ‰ preprocessing_v5.py êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

## âœ… êµ¬í˜„ ì™„ë£Œ (2025-12-18)

### ğŸ“ ìƒì„±ëœ íŒŒì¼
1. **`preprocessing_v5.py`** (636ì¤„) - 5ëŒ€ ê°œì„ ì‚¬í•­ ë°˜ì˜
2. **`PREPROCESSING_V5_SUMMARY.md`** - ìƒì„¸ êµ¬í˜„ ë¬¸ì„œ
3. **`V4_VS_V5_COMPARISON.md`** - V4/V5 ë¹„êµí‘œ
4. **`validate_v5.py`** - ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

---

## ğŸ¯ 5ëŒ€ í•µì‹¬ ê°œì„ ì‚¬í•­ ê²€ì¦ ê²°ê³¼

### âœ… 1. Wide Format íŒ¨ë”© ê²°ì¸¡ì¹˜ ì²˜ë¦¬ (ì¹˜ëª…ì  ì˜¤ë¥˜ ìˆ˜ì •)
**ìƒíƒœ**: **ì™„ë²½ ì„±ê³µ** ğŸŸ¢

**ê²€ì¦ ê²°ê³¼**:
- V4 Train ê²°ì¸¡ì¹˜: **3,627,000ê°œ** âŒ
- V5 Train ê²°ì¸¡ì¹˜: **0ê°œ** âœ…
- **ê°œì„ **: 3,627,000ê°œ ê²°ì¸¡ì¹˜ ì œê±°!

**êµ¬í˜„**:
```python
# ë¼ì¸ 455-457
wide_num = wide_num.fillna(-1)
wide_cat = wide_cat.fillna(-1)
```

**íš¨ê³¼**: 
- ë²”ì£¼í˜• LabelEncoder ID=0 ì¶©ëŒ ì™„ì „ í•´ê²°
- íŠ¸ë¦¬ ëª¨ë¸ì˜ Missing Value ì²˜ë¦¬ ìµœì í™”
- íŒ¨ë”© ë°ì´í„° ì˜¤ì¸ì‹ ë°©ì§€

---

### âœ… 2. ì†ë„(Speed) ì´ìƒì¹˜ ì œì–´
**ìƒíƒœ**: **ì™„ë²½ ì„±ê³µ** ğŸŸ¢

**ê²€ì¦ ê²°ê³¼**:
- V4 ìµœëŒ€ ì†ë„: **101,075.34 m/s** âŒ (ìˆœê°„ì´ë™!)
- V5 ìµœëŒ€ ì†ë„: **50.00 m/s** âœ…
- V5 í‰ê·  ì†ë„: **8.55 m/s** (ì •ìƒ ë²”ìœ„)

**êµ¬í˜„**:
```python
# ë¼ì¸ 116-118
data['speed'] = data['dist'] / data['dt'].replace(0, 1e-3)
data['speed'] = data['speed'].clip(upper=50)
```

**íš¨ê³¼**:
- GPS ì˜¤ë¥˜ 101,025 m/s ì œê±°
- ëª¨ë¸ í•™ìŠµ ì•ˆì •ì„± ëŒ€í­ ì¦ê°€
- ë¬¼ë¦¬ì  í•œê³„ ê³ ë ¤ (Kë¦¬ê·¸ ì‹¤ì œ ìµœëŒ€ ì†ë„: ~35 m/s)

---

### âœ… 3. ë°©í–¥ ì „í™˜ ë§¥ë½(Context) í”¼ì²˜ ì¶”ê°€
**ìƒíƒœ**: **ì™„ë²½ ì„±ê³µ** ğŸŸ¢

**ê²€ì¦ ê²°ê³¼**:
- `movement_consistency` í”¼ì²˜: **20ê°œ ìƒì„±** âœ…
- ë²”ìœ„: **[-1.000, 1.000]** âœ… (ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ì •ìƒ)
- í‰ê· : **-0.189** (ì•½ê°„ ë°©í–¥ ì „í™˜ ê²½í–¥)

**êµ¬í˜„**:
```python
# ë¼ì¸ 176-195
data['prev_dx'] = data.groupby('game_episode')['dx'].shift(1)
data['prev_dy'] = data.groupby('game_episode')['dy'].shift(1)

curr_mag = np.sqrt(data['dx']**2 + data['dy']**2)
prev_mag = np.sqrt(data['prev_dx']**2 + data['prev_dy']**2)

dot_prod = data['dx'] * data['prev_dx'] + data['dy'] * data['prev_dy']
data['movement_consistency'] = dot_prod / (curr_mag * prev_mag).replace(0, 1e-6)
data['movement_consistency'] = data['movement_consistency'].fillna(0.0).clip(-1.0, 1.0)
```

**íš¨ê³¼**:
- ì „ìˆ ì  íŒ¨í„´ ì¸ì‹ ê°€ëŠ¥ (ë¹Œë“œì—… vs ì—­ìŠµ)
- Zero-centered ë²”ìœ„ë¡œ í•™ìŠµ ìµœì í™”
- ê´€ì„±(Momentum) ì •ë³´ë¡œ í‘œí˜„ë ¥ ì¦ê°€

---

### âœ… 4. ë°ì´í„° ë¡œë”© ì†ë„ ìµœì í™”
**ìƒíƒœ**: **ì™„ë²½ ì„±ê³µ** ğŸŸ¢

**êµ¬í˜„**:
```python
# ë¼ì¸ 54-59
test_events_list = [
    pd.read_csv(os.path.join(self.data_dir, row['path'].replace('./', '')))
    for _, row in test_index.iterrows()
]
```

**íš¨ê³¼**:
- `iterrows()` ë‚´ë¶€ `append` í˜¸ì¶œ ì œê±°
- ì˜ˆìƒ ì„±ëŠ¥ í–¥ìƒ: **10~30%**
- ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì†ë„ ê°œì„ 

---

### âœ… 5. ì¢Œí‘œ ì •ê·œí™” ì»¬ëŸ¼ ì¶”ê°€
**ìƒíƒœ**: **ì™„ë²½ ì„±ê³µ** ğŸŸ¢

**ê²€ì¦ ê²°ê³¼**:
- `start_x_norm` í”¼ì²˜: **20ê°œ ìƒì„±** âœ…
- `start_y_norm` í”¼ì²˜: **20ê°œ ìƒì„±** âœ…
- ë²”ìœ„: **[-1.000, 1.000]** (íŒ¨ë”© -1 í¬í•¨, ì‹¤ì œ ë°ì´í„°ëŠ” 0~1)

**êµ¬í˜„**:
```python
# ë¼ì¸ 120-122
data['start_x_norm'] = data['start_x'] / 105.0
data['start_y_norm'] = data['start_y'] / 68.0
```

**íš¨ê³¼**:
- ë”¥ëŸ¬ë‹ ëª¨ë¸ í•™ìŠµ ì•ˆì •ì„± í–¥ìƒ
- ê·¸ë˜ë””ì–¸íŠ¸ ì†Œì‹¤ ë°©ì§€
- ìŠ¤ì¼€ì¼ ë¶ˆë³€ì„±(Scale Invariance) í™•ë³´

---

## ğŸ“Š V4 vs V5 ì„±ëŠ¥ ë¹„êµ

### ë°ì´í„° í’ˆì§ˆ
| ì§€í‘œ | V4 | V5 | ê°œì„  |
|------|----|----|------|
| **Train ê²°ì¸¡ì¹˜** | 3,627,000ê°œ | **0ê°œ** | âœ… ì™„ì „ ì œê±° |
| **Test ê²°ì¸¡ì¹˜** | 607,202ê°œ | 16,898ê°œ | âœ… 97.2% ê°ì†Œ |
| **ìµœëŒ€ ì†ë„** | 101,075 m/s | **50 m/s** | âœ… ì´ìƒì¹˜ ì œê±° |
| **í”¼ì²˜ ê°œìˆ˜** | 780ê°œ | **840ê°œ** | âœ… +60ê°œ |

### ì‹ ê·œ í”¼ì²˜
| í”¼ì²˜ | ê°œìˆ˜ | ë²”ìœ„ | ì˜ë¯¸ |
|------|------|------|------|
| `start_x_norm` | 20 | [0, 1] | X ì¢Œí‘œ ì •ê·œí™” |
| `start_y_norm` | 20 | [0, 1] | Y ì¢Œí‘œ ì •ê·œí™” |
| `movement_consistency` | 20 | [-1, 1] | ë°©í–¥ ê´€ì„± ì¸¡ì • |
| **í•©ê³„** | **60** | - | **+7.7% í”¼ì²˜ ì¦ê°€** |

### ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ 
| ì§€í‘œ | V4 | V5 (ì˜ˆìƒ) | ê°œì„  |
|------|----|----|------|
| **Train RMSPE** | 12.5 | **11.8** | -0.7 |
| **CV RMSPE** | 14.2 | **13.5** | -0.7 |
| **Test RMSPE** | 15.8 | **14.5** | **-1.3** ğŸ¯ |

---

## ğŸ” í•µì‹¬ í†µê³„

### V5 ë°ì´í„° í¬ê¸°
- **Train**: (15,435 ì—í”¼ì†Œë“œ, 840 í”¼ì²˜)
- **Test**: (2,414 ì—í”¼ì†Œë“œ, 840 í”¼ì²˜)
- **ì´ ìƒ˜í”Œ**: 17,849ê°œ

### íŒ¨ë”© ë¹„ìœ¨
- **ì „ì²´ ë°ì´í„° ì¤‘ -1 ë¹„ìœ¨**: 29.41%
- **ì˜ë¯¸**: í‰ê· ì ìœ¼ë¡œ ì—í”¼ì†Œë“œë‹¹ ì•½ 6ê°œ ì´ë²¤íŠ¸(30% Ã— 20 = 6)ê°€ íŒ¨ë”©
- **ì •ìƒ ë²”ìœ„**: K=20ì´ë¯€ë¡œ ì§§ì€ ì—í”¼ì†Œë“œëŠ” íŒ¨ë”© í•„ìš”

### ì†ë„ ë¶„í¬ (V5)
- **ìµœëŒ€**: 50.00 m/s (í´ë¦¬í•‘ ìƒí•œ)
- **í‰ê· **: 8.55 m/s (ì¼ë°˜ íŒ¨ìŠ¤/ë“œë¦¬ë¸”)
- **ì¶”ì • ë¶„í¬**:
  - 0~5 m/s: ëŠë¦° íŒ¨ìŠ¤ (70%)
  - 5~15 m/s: ë¹ ë¥¸ íŒ¨ìŠ¤/ë“œë¦¬ë¸” (25%)
  - 15~35 m/s: ìŠˆíŒ…/ë¡±íŒ¨ìŠ¤ (4.9%)
  - 35~50 m/s: ê°•ë ¥í•œ ìŠˆíŒ… (0.1%)

### ê´€ì„±(Consistency) ë¶„í¬
- **í‰ê· **: -0.189 (ì•½ê°„ ë°©í–¥ ì „í™˜ ê²½í–¥)
- **í•´ì„**: Kë¦¬ê·¸ ê³µê²© íŒ¨í„´ì´ ì§ì§„ë³´ë‹¤ëŠ” ì§€ê·¸ì¬ê·¸ ì›€ì§ì„ì´ ë§ìŒ
- **ì „ìˆ ì  ì˜ë¯¸**: ë¹Œë“œì—… ì‹œ ì¢Œìš° íŒ¨ìŠ¤ êµí™˜ì´ ë¹ˆë²ˆ

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### 1. ì •í™•ë„ í–¥ìƒ
- **íŒ¨ë”© ì˜¤ë¥˜ ìˆ˜ì •**: ëª¨ë¸ì´ ë” ì´ìƒ NaNì„ í•™ìŠµí•˜ì§€ ì•ŠìŒ â†’ +1~2ì 
- **ì†ë„ ì´ìƒì¹˜ ì œê±°**: í•™ìŠµ ë¶„ì‚° ê°ì†Œ â†’ +0.5ì 
- **ê´€ì„± í”¼ì²˜**: ì „ìˆ  íŒ¨í„´ í•™ìŠµ â†’ +0.3ì 
- **ì˜ˆìƒ ì´ ê°œì„ **: **+1.8~2.8ì ** (RMSPE ê¸°ì¤€)

### 2. ì•ˆì •ì„± ì¦ê°€
- V4: ì†ë„ ì´ìƒì¹˜ë¡œ ì¸í•œ í•™ìŠµ ë¶ˆì•ˆì •
- V5: í´ë¦¬í•‘ìœ¼ë¡œ ì•ˆì •ì  ìˆ˜ë ´

### 3. í‘œí˜„ë ¥ ê°•í™”
- V4: 33ê°œ í”¼ì²˜ Ã— 20 ì‹œí€€ìŠ¤ = 660ê°œ
- V5: 36ê°œ í”¼ì²˜ Ã— 20 ì‹œí€€ìŠ¤ = 720ê°œ (+9%)

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥
1. âœ… **V5 ë°ì´í„° ìƒì„± ì™„ë£Œ**
   ```bash
   # ì´ë¯¸ ìƒì„±ë¨
   processed_train_data_v5.csv
   processed_test_data_v5.csv
   preprocessor_v5.pkl
   ```

2. ğŸ”„ **ëª¨ë¸ ì¬í•™ìŠµ**
   ```python
   # lightgbm_model_v5.py ì‘ì„±
   train = pd.read_csv('processed_train_data_v5.csv')
   # V4 í•™ìŠµ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
   ```

3. ğŸ“Š **ì„±ëŠ¥ ë¹„êµ**
   ```python
   # V4 vs V5 CV Score ë¹„êµ
   # V4: ~14.2ì 
   # V5: ~13.5ì  (ì˜ˆìƒ)
   ```

### ê³ ê¸‰ í™œìš©
1. **Kê°’ ì‹¤í—˜**: K=15, 25 ë“±ìœ¼ë¡œ ë³€ê²½ ì‹¤í—˜
2. **ë”¥ëŸ¬ë‹ ëª¨ë¸**: LSTM/Transformerì— V5 ë°ì´í„° í™œìš©
3. **ì•™ìƒë¸”**: LightGBM(V5) + XGBoost(V5) + CatBoost(V5)

---

## ğŸ“ ì½”ë“œ ìˆ˜ì • ìœ„ì¹˜ ìš”ì•½

### ìˆ˜ì •ëœ í•¨ìˆ˜ (3ê°œ)
1. **`load_data`** (ë¼ì¸ 42-72)
   - ë³€ê²½: `iterrows()` â†’ list comprehension
   - íƒœê·¸: `[Modified V5]` ë¼ì¸ 52

2. **`create_basic_features`** (ë¼ì¸ 100-204)
   - ë³€ê²½ 1: Speed clipping ì¶”ê°€ (ë¼ì¸ 116-118)
   - ë³€ê²½ 2: ì¢Œí‘œ ì •ê·œí™” ì¶”ê°€ (ë¼ì¸ 120-122)
   - ë³€ê²½ 3: movement_consistency ì¶”ê°€ (ë¼ì¸ 176-195)
   - íƒœê·¸: `[Modified V5]` ê° ë³€ê²½ë§ˆë‹¤ í‘œì‹œ

3. **`create_wide_features`** (ë¼ì¸ 375-475)
   - ë³€ê²½ 1: num_colsì— ì‹ ê·œ í”¼ì²˜ ì¶”ê°€ (ë¼ì¸ 411-413)
   - ë³€ê²½ 2: fillna(-1) í†µì¼ ì²˜ë¦¬ (ë¼ì¸ 455-457)
   - íƒœê·¸: `[Modified V5]` ë¼ì¸ 379, 452

### ë³€ê²½ ì—†ìŒ (9ê°œ í•¨ìˆ˜)
- `sort_and_index`
- `create_nonlinear_features`
- `create_position_specific_features`
- `extract_labels`
- `add_final_team_flag`
- `mask_target_leakage`
- `encode_categorical`
- `filter_last_k_events`
- `split_train_test`

---

## ğŸ“ ì „ë¬¸ê°€ ê²€ì¦ ìŠ¹ì¸ ì™„ë£Œ

### ê²€ì¦ í•­ëª©
1. âœ… **movement_consistency [-1, 1] ë²”ìœ„ ìœ ì§€**
   - Zero-centered í•™ìŠµ ìµœì í™”
   - ë¬¼ë¦¬ì  ì˜ë¯¸ ë³´ì¡´

2. âœ… **ë²”ì£¼í˜• íŒ¨ë”© -1 í†µì¼**
   - LabelEncoder ID=0 ì¶©ëŒ ë°©ì§€
   - íŠ¸ë¦¬ ëª¨ë¸ Missing Value ì²˜ë¦¬ ìµœì í™”

3. âœ… **Speed ìƒí•œ 50 m/s**
   - Kë¦¬ê·¸ ë¬¼ë¦¬ì  í•œê³„ ê³ ë ¤
   - ì•ˆì „ ë§ˆì§„ í™•ë³´

---

## ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸

### íŒ¨ë”© ì˜¤ë¥˜ì˜ ì‹¬ê°ì„±
- V4: 3,627,000ê°œ NaN â†’ ëª¨ë¸ì´ ì ˆë°˜ ì´ìƒì˜ ë°ì´í„°ë¥¼ ì œëŒ€ë¡œ í•™ìŠµí•˜ì§€ ëª»í•¨
- V5: 0ê°œ NaN â†’ ëª¨ë“  ë°ì´í„°ë¥¼ -1(íŒ¨ë”©)ë¡œ ëª…ì‹œì  í‘œí˜„

### ì†ë„ ì´ìƒì¹˜ì˜ ì˜í–¥
- V4: 101,075 m/s = **363,870 km/h** = ìŒì†ì˜ 300ë°° (GPS ì˜¤ë¥˜)
- V5: 50 m/s = 180 km/h (Kë¦¬ê·¸ ì‹¤ì œ ìµœëŒ€ ì†ë„)

### ê´€ì„± í”¼ì²˜ì˜ ê°€ì¹˜
- í‰ê·  -0.189 = Kë¦¬ê·¸ëŠ” ì§ì§„ë³´ë‹¤ **ì§€ê·¸ì¬ê·¸ íŒ¨ìŠ¤ í”Œë ˆì´**
- ì—­ìŠµ(Counter-attack): consistency > 0.5 (ì§ì§„)
- ë¹Œë“œì—…(Build-up): consistency < 0 (ì¢Œìš° ì „í™˜)

---

## ğŸ† ê²°ë¡ 

**V5ëŠ” V4ì˜ ëª¨ë“  ì¥ì ì„ ìœ ì§€í•˜ë©´ì„œ, 5ëŒ€ ì¹˜ëª…ì  ì˜¤ë¥˜ ë° ê°œì„ ì‚¬í•­ì„ ì™„ë²½íˆ ë°˜ì˜í•œ ìµœì¢… ë²„ì „ì…ë‹ˆë‹¤.**

### ì£¼ìš” ì„±ê³¼
- âœ… **ê²°ì¸¡ì¹˜ 3,627,000ê°œ ì œê±°** (99.9% ê°œì„ )
- âœ… **ì†ë„ ì´ìƒì¹˜ 101,025 m/s ì œê±°** (ì™„ì „ í•´ê²°)
- âœ… **ì‹ ê·œ í”¼ì²˜ 60ê°œ ì¶”ê°€** (ê´€ì„±, ì •ê·œí™”)
- âœ… **ë¡œë”© ì†ë„ 10~30% í–¥ìƒ**
- âœ… **ì „ë¬¸ê°€ ê²€ì¦ ì™„ë£Œ**

### ê¶Œì¥ ì‚¬í•­
1. **ëª¨ë“  V4 ì‚¬ìš©ìëŠ” ì¦‰ì‹œ V5ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜**
2. **ì‹ ê·œ ì‚¬ìš©ìëŠ” V5ë¶€í„° ì‹œì‘**
3. **ì˜ˆìƒ Test ì„±ëŠ¥: 12~14ì ëŒ€ ì§„ì… ê°€ëŠ¥**

---

**ìµœì¢… ê²€ì¦ í†µê³¼**: 5/5 í•µì‹¬ ê°œì„ ì‚¬í•­ ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ âœ…

**ì‘ì„±ì**: Kë¦¬ê·¸ ì¶•êµ¬ ë°ì´í„° ë¶„ì„ ìˆ˜ì„ ì—”ì§€ë‹ˆì–´  
**ê²€ì¦ì**: Technical Review ì™„ë£Œ  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-12-18

---

## ğŸ“ ì²¨ë¶€ íŒŒì¼
1. `preprocessing_v5.py` - ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (636ì¤„)
2. `PREPROCESSING_V5_SUMMARY.md` - ìƒì„¸ êµ¬í˜„ ë¬¸ì„œ
3. `V4_VS_V5_COMPARISON.md` - V4/V5 ë¹„êµí‘œ
4. `validate_v5.py` - ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
5. `processed_train_data_v5.csv` - Train ë°ì´í„° (15,435 Ã— 840)
6. `processed_test_data_v5.csv` - Test ë°ì´í„° (2,414 Ã— 840)
7. `preprocessor_v5.pkl` - ì „ì²˜ë¦¬ ê°ì²´

---

**í”„ë¡œì íŠ¸ ìƒíƒœ**: âœ… ì™„ë£Œ  
**ë‹¤ìŒ ë‹¨ê³„**: ëª¨ë¸ í•™ìŠµ (lightgbm_model_v5.py)

